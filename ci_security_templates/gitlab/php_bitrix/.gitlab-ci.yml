include:
  - local: 'ci_security_templates/gitlab/shared/includes/sast.yml'
  - local: 'ci_security_templates/gitlab/shared/includes/dependency_scan.yml'
  - local: 'ci_security_templates/gitlab/shared/includes/container_scan.yml'

stages:
  - test
  - lint
  - sast
  - deps
  - container_scan
  - deploy

variables:
  APP_IMAGE: "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA"

php_tests:
  stage: test
  image: php:8.1-cli
  script:
    - composer install --no-interaction --prefer-dist || true
    - php vendor/bin/phpunit --testdox || echo "Add phpunit to enable"
  artifacts:
    when: always
    paths:
      - tests/_reports/

php_lint:
  stage: lint
  image: php:8.1-cli
  needs: ["php_tests"]
  script:
    - find . -name "*.php" -not -path "./vendor/*" -print0 | xargs -0 -r php -l

php_sast_local:
  stage: sast
  needs: ["php_tests"]
  image: php:8.1-cli
  script:
    - composer require --dev phpstan/phpstan || true
    - vendor/bin/phpstan analyse --memory-limit=512M || true
  artifacts:
    when: always
    paths:
      - phpstan.neon

composer_audit:
  stage: deps
  needs: ["php_tests"]
  image: php:8.1-cli
  script:
    - composer install --no-interaction --prefer-dist || true
    - composer audit || true

trivy_container_scan:
  stage: container_scan
  image:
    name: docker:24-cli
    entrypoint: [""]
  services:
    - docker:24-dind
  needs: ["php_tests", "php_lint", "php_sast_local", "composer_audit"]
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - docker build -t "$APP_IMAGE" .
    - apk add --no-cache curl
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
    - trivy image --exit-code 0 --format table "$APP_IMAGE" || true

# Опционально можно добавить deploy stage под вашу инфраструктуру
