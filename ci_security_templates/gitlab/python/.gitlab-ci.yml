include:
  - local: 'ci_security_templates/gitlab/shared/includes/sast.yml'
  - local: 'ci_security_templates/gitlab/shared/includes/dependency_scan.yml'
  - local: 'ci_security_templates/gitlab/shared/includes/container_scan.yml'

stages:
  - test
  - lint
  - sast
  - deps
  - container_scan

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

python_tests:
  stage: test
  image: python:3.11
  script:
    - python -m pip install --upgrade pip
    - if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    - pip install pytest
    - pytest -q

python_lint:
  stage: lint
  needs: ["python_tests"]
  image: python:3.11
  script:
    - pip install ruff
    - ruff .

python_sast:
  stage: sast
  needs: ["python_tests"]
  image: python:3.11
  script:
    - pip install bandit
    - bandit -q -r . || true

python_deps_scan:
  stage: deps
  needs: ["python_tests"]
  image: python:3.11
  script:
    - pip install pip-audit
    - if [ -f requirements.txt ]; then pip-audit -r requirements.txt || true; fi

python_container_scan:
  stage: container_scan
  needs: ["python_tests", "python_lint", "python_sast", "python_deps_scan"]
  image:
    name: docker:24-cli
    entrypoint: [""]
  services:
    - docker:24-dind
  script:
    - docker build -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA" .
    - apk add --no-cache curl
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
    - trivy image --exit-code 0 --format table "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA" || true
