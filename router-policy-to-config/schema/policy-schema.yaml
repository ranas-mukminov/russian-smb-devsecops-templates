$schema: http://json-schema.org/draft-07/schema#
title: Router Policy Schema
description: Vendor-agnostic router policy schema for generating RouterOS and OpenWrt configurations
type: object
required:
  - meta
  - wan
properties:
  meta:
    type: object
    required:
      - name
      - target
    properties:
      name:
        type: string
        description: Human-readable name for this policy
        minLength: 1
      description:
        type: string
        description: Optional description of the network setup
      target:
        type: object
        required:
          - vendor
        properties:
          vendor:
            type: string
            enum: [routeros, openwrt]
            description: Target vendor platform
          version:
            type: string
            description: Target version (e.g., v6, v7 for RouterOS)
            pattern: "^v?[0-9]+(\\.[0-9]+)*$"

  wan:
    type: object
    required:
      - type
      - interface
    properties:
      type:
        type: string
        enum: [pppoe, dhcp, static]
        description: WAN connection type
      interface:
        type: string
        description: Physical interface for WAN (e.g., ether1, eth0)
        minLength: 1
      username:
        type: string
        description: Username for PPPoE (required if type is pppoe)
      password_ref:
        type: string
        description: Reference to password secret (e.g., secret:pppoe_password)
        pattern: "^secret:[a-zA-Z0-9_]+$"
      ip:
        type: string
        description: Static IP address (required if type is static)
        pattern: "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$"
      netmask:
        type: string
        description: Network mask for static IP
        pattern: "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$"
      gateway:
        type: string
        description: Gateway IP for static configuration
        pattern: "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$"
      dns:
        type: array
        description: DNS servers
        items:
          type: string
          pattern: "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$"
      mtu:
        type: integer
        description: MTU size
        minimum: 576
        maximum: 9000

  lans:
    type: array
    description: LAN network definitions
    items:
      type: object
      required:
        - name
        - subnet
        - gateway
      properties:
        name:
          type: string
          description: LAN identifier
          pattern: "^[a-zA-Z0-9_-]+$"
        subnet:
          type: string
          description: LAN subnet in CIDR notation
          pattern: "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"
        gateway:
          type: string
          description: Gateway IP address
          pattern: "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$"
        vlan_id:
          type: integer
          description: Optional VLAN ID
          minimum: 1
          maximum: 4094
        interface:
          type: string
          description: Physical interface or bridge
        dhcp:
          type: object
          properties:
            enabled:
              type: boolean
              description: Enable DHCP server
            range:
              type: string
              description: DHCP range (e.g., 192.168.10.100-192.168.10.200)
              pattern: "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}-(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$"
            lease_time:
              type: string
              description: DHCP lease time (e.g., 24h, 1d)
              pattern: "^[0-9]+[smhd]$"
            dns_servers:
              type: array
              items:
                type: string
                pattern: "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$"
        isolated_from:
          type: array
          description: List of LAN names this network is isolated from
          items:
            type: string

  wifi:
    type: array
    description: Wi-Fi access point configurations
    items:
      type: object
      required:
        - name
        - lan
        - ssid
        - mode
      properties:
        name:
          type: string
          description: Wi-Fi interface identifier
          pattern: "^[a-zA-Z0-9_-]+$"
        lan:
          type: string
          description: Associated LAN name
        ssid:
          type: string
          description: SSID (network name)
          minLength: 1
          maxLength: 32
        mode:
          type: string
          enum: [ap, sta, mesh]
          description: Operating mode (ap=access point, sta=station/client, mesh=mesh node)
        channel:
          type: integer
          description: Wi-Fi channel
          minimum: 1
          maximum: 165
        band:
          type: string
          enum: [2.4ghz, 5ghz, 6ghz]
          description: Frequency band
        hidden:
          type: boolean
          description: Hide SSID
        guest:
          type: boolean
          description: Mark as guest network (implies additional isolation)
        security:
          type: object
          required:
            - encryption
          properties:
            encryption:
              type: string
              enum: [none, wep, wpa-psk, wpa2-psk, wpa3-psk, wpa2-enterprise]
              description: Encryption method
            password_ref:
              type: string
              description: Reference to Wi-Fi password secret
              pattern: "^secret:[a-zA-Z0-9_]+$"
            radius_server:
              type: string
              description: RADIUS server for enterprise mode
            radius_secret_ref:
              type: string
              description: RADIUS secret reference
              pattern: "^secret:[a-zA-Z0-9_]+$"

  vpn:
    type: array
    description: VPN configurations
    items:
      type: object
      required:
        - type
        - role
      properties:
        type:
          type: string
          enum: [wireguard, openvpn, ipsec]
          description: VPN protocol type
        role:
          type: string
          enum: [server, client]
          description: VPN role
        listen_port:
          type: integer
          description: Listening port for server mode
          minimum: 1
          maximum: 65535
        interface:
          type: string
          description: VPN interface name
        allowed_ips:
          type: array
          description: Allowed IP ranges for VPN clients
          items:
            type: string
            pattern: "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"
        endpoint:
          type: string
          description: Remote endpoint for client mode (host:port)
        public_key_ref:
          type: string
          description: Reference to public key secret
          pattern: "^secret:[a-zA-Z0-9_]+$"
        private_key_ref:
          type: string
          description: Reference to private key secret
          pattern: "^secret:[a-zA-Z0-9_]+$"
        peers:
          type: array
          description: VPN peer configurations
          items:
            type: object
            properties:
              name:
                type: string
              public_key_ref:
                type: string
                pattern: "^secret:[a-zA-Z0-9_]+$"
              allowed_ips:
                type: array
                items:
                  type: string

  firewall:
    type: object
    properties:
      default_policy:
        type: string
        enum: [accept, drop, reject]
        description: Default firewall policy
        default: drop
      rules:
        type: array
        description: Firewall rules
        items:
          type: object
          required:
            - name
            - action
          properties:
            name:
              type: string
              description: Rule name/description
              pattern: "^[a-zA-Z0-9_-]+$"
            from:
              type: array
              description: Source zones/networks
              items:
                type: string
            to:
              type: array
              description: Destination zones/networks
              items:
                type: string
            action:
              type: string
              enum: [accept, drop, reject]
              description: Action to take
            protocol:
              type: string
              enum: [tcp, udp, icmp, all]
              description: Protocol to match
            port:
              oneOf:
                - type: integer
                  minimum: 1
                  maximum: 65535
                - type: string
                  pattern: "^[0-9]+-[0-9]+$"
              description: Port or port range
            state:
              type: array
              description: Connection states to match
              items:
                type: string
                enum: [new, established, related, invalid]
            log:
              type: boolean
              description: Enable logging for this rule
            comment:
              type: string
              description: Additional comment for the rule

  dns:
    type: object
    description: DNS configuration
    properties:
      servers:
        type: array
        description: DNS servers
        items:
          type: string
          pattern: "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$"
      domain:
        type: string
        description: Local domain name
      forwarders:
        type: array
        description: DNS forwarders
        items:
          type: string

  nat:
    type: object
    description: NAT configuration
    properties:
      masquerade:
        type: boolean
        description: Enable masquerade NAT on WAN
        default: true
      port_forwards:
        type: array
        description: Port forwarding rules
        items:
          type: object
          required:
            - external_port
            - internal_ip
            - internal_port
          properties:
            name:
              type: string
            protocol:
              type: string
              enum: [tcp, udp, both]
            external_port:
              type: integer
              minimum: 1
              maximum: 65535
            internal_ip:
              type: string
              pattern: "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$"
            internal_port:
              type: integer
              minimum: 1
              maximum: 65535
